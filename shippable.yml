language: java
jdk: openjdk9

branches:
  only:
    - master

env:
  global:
    - BALLERINA_VERSION=0.975.0
    - DISTRIBUTION_NAME=ballerina-platform-$BALLERINA_VERSION

build:
  ci:
    - pushd $HOME
    - wget https://product-dist.ballerina.io/downloads/$BALLERINA_VERSION/$DISTRIBUTION_NAME.zip
    - unzip $DISTRIBUTION_NAME.zip
    - export PATH=$PATH:$HOME/$DISTRIBUTION_NAME/bin
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
    - chmod +x ./kubectl
    - sudo mv ./kubectl /usr/local/bin/kubectl
    - popd
    - ballerina version
    - ballerina build btest
    - ballerina test btest

    
  on_failure:  
    - cat ballerina-internal.log
    
  post_ci:
    - docker tag pzfreo/btest gcr.io/pzfreo/btest
    - docker push gcr.io/pzfreo/btest
    - kubectl apply -f target/kubernetes    
    
    
    
resources:
  - name: deploy_kube_runsh_cli_kubectl
    type: cliConfig
    integration: my-k8s

    
integrations:
  hub:
    - integrationName: gcloud
      type: gcloudKey

#    - integrationName: docker-registry 
#      type: dockerRegistryLogin
#
